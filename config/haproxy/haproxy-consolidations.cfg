global
    daemon
    log stdout local0 info
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option redispatch
    option forwardfor
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3

# Frontend para Consolidations API
frontend consolidations_front
    bind *:8080
    mode http

    # Health check endpoint
    acl health_check path_beg /health
    use_backend health_backend if health_check

    default_backend consolidations_backend

# Backend Consolidations API (Load Balanced)
backend consolidations_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    server consolidations-api-1 consolidations-api-1:5002 check inter 10s fall 3 rise 2
    server consolidations-api-2 consolidations-api-2:5002 check inter 10s fall 3 rise 2

# Health check backend
backend health_backend
    mode http
    http-request return status 200 content-type text/plain string "Consolidations HAProxy OK"

# Stats frontend
frontend stats
    bind *:8282
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
