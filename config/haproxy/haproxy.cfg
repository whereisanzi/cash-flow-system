global
    daemon
    log stdout local0 info
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option redispatch
    option forwardfor
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3

# Frontend - Load Balancer
frontend api_loadbalancer
    bind *:8080
    mode http

    # Health check endpoint
    acl health_check path_beg /health
    use_backend health_backend if health_check

    # Route to transactions API
    acl transactions_api path_reg /api/v1/merchants/.*?/transactions
    use_backend transactions_backend if transactions_api

    # Route to consolidations API
    acl consolidations_api path_reg /api/v1/merchants/.*?/consolidations/
    use_backend consolidations_backend if consolidations_api

    # Default to transactions
    default_backend transactions_backend

# Transactions API Backend (Load Balanced)
backend transactions_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # Multiple instances for high availability
    server transactions-api-1 172.22.0.30:5001 check inter 10s fall 3 rise 2
    server transactions-api-2 172.22.0.31:5001 check inter 10s fall 3 rise 2

# Consolidations API Backend (Load Balanced)
backend consolidations_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # Multiple instances for high availability
    server consolidations-api-1 172.22.0.40:5002 check inter 10s fall 3 rise 2
    server consolidations-api-2 172.22.0.41:5002 check inter 10s fall 3 rise 2

# Health check backend
backend health_backend
    mode http
    http-request return status 200 content-type text/plain string "HAProxy OK"

# Stats frontend
frontend stats
    bind *:8081
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE

