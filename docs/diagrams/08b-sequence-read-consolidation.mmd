sequenceDiagram
  autonumber
  participant Client
  participant Gateway as KrakenD
  participant LB as HAProxy (CO)
  participant Controller as ConsolidationController
  participant Service as ConsolidationService
  participant Repository as DailyConsolidationRepository
  participant Context as ConsolidationsDbContext
  participant DB as PgBouncer/PostgreSQL

  Note over Client,Gateway: Cliente solicita consolidação diária
  Client->>Gateway: GET /api/v1/merchants/{id}/consolidations/daily?date=2025-09-24 (JWT)
  Gateway->>Gateway: Valida JWT (RS256, JWK do Keycloak)

  Note over Gateway,LB: Roteamento para Consolidations API
  Gateway->>LB: encaminha requisição autenticada
  LB->>Controller: HTTP GET request

  Note over Controller,Service: Processamento da consulta
  Controller->>Controller: Valida parâmetros (merchantId, date)
  Controller->>Service: GetDailyConsolidationAsync(merchantId, date)

  Note over Service,Repository: Camada de domínio e persistência
  Service->>Repository: GetByMerchantAndDateAsync(merchantId, date)
  Repository->>Context: FindAsync usando LINQ
  Context->>DB: SELECT query com filtros

  alt Consolidação encontrada
    DB-->>Context: Retorna registro da consolidação
    Context-->>Repository: DailyConsolidation entity
    Repository-->>Service: DailyConsolidation domain object
    Service-->>Controller: DailyConsolidation

    Note over Controller: Mapeamento para resposta
    Controller->>Controller: Map to DailyConsolidationResponse
    Controller-->>LB: 200 OK + consolidation data
    LB-->>Gateway: resposta com dados
    Gateway-->>Client: 200 OK + JSON response

  else Consolidação não encontrada
    DB-->>Context: Retorna null
    Context-->>Repository: null
    Repository-->>Service: null
    Service-->>Controller: null
    Controller-->>LB: 404 Not Found
    LB-->>Gateway: 404 response
    Gateway-->>Client: 404 Not Found

  else Erro na consulta
    DB-->>Context: SQL Exception
    Context-->>Repository: Exception
    Repository-->>Service: Exception
    Service-->>Controller: Exception
    Controller-->>LB: 500 Internal Server Error
    LB-->>Gateway: error response
    Gateway-->>Client: 500 Internal Server Error
  end

  Note over Client,DB: Fluxo de leitura otimizado
  Note right of DB: • Índice único (MerchantId, Date)<br/>• PgBouncer para pool de conexões<br/>• EF Core com tracking desabilitado<br/>• Cache potencial em níveis superiores