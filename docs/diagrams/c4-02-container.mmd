graph TB
  subgraph Users[Users]
    Merchant[Merchant<br/>Business owner tracking cash flow]
    Admin[Administrator<br/>System operator]
  end

  subgraph ExternalSystems[External Systems]
    Keycloak[Keycloak<br/>Identity Provider<br/>OAuth2/JWT]
  end

  subgraph CashFlowSystem[Cash Flow System]
    subgraph Gateway[API Gateway]
      KrakenD[KrakenD API Gateway<br/>.NET/Go, Port 8000<br/>Single entry point, JWT validation<br/>rate limiting, routing]
    end

    subgraph TransactionsDomain[Transactions Domain]
      TxAPI[Transactions API<br/>.NET 9, Port 5001<br/>Records financial transactions<br/>using Flows pattern]
      TxDB[(Transactions Database<br/>PostgreSQL<br/>Stores transaction records)]
      TxPool[Transactions PgBouncer<br/>Connection Pool<br/>Optimizes database connections]
    end

    subgraph ConsolidationsDomain[Consolidations Domain]
      CoAPI[Consolidations API<br/>.NET 9, Port 5002<br/>Provides daily consolidations<br/>using Repository pattern]
      CoDB[(Consolidations Database<br/>PostgreSQL<br/>Stores daily consolidation projections)]
      CoPool[Consolidations PgBouncer<br/>Connection Pool<br/>Optimizes database connections]
    end

    subgraph Messaging[Event-Driven Integration]
      RabbitMQ[RabbitMQ<br/>Message Broker<br/>Handles async communication<br/>between services]
    end

    subgraph LoadBalancing[Load Balancing]
      TxLB[HAProxy TX<br/>Load Balancer<br/>Distributes traffic to<br/>Transactions API instances]
      CoLB[HAProxy CO<br/>Load Balancer<br/>Distributes traffic to<br/>Consolidations API instances]
    end

    subgraph Observability[Observability Stack]
      Prometheus[Prometheus<br/>Metrics Collection<br/>Scrapes and stores metrics]
      Grafana[Grafana<br/>Visualization<br/>Dashboards and alerting]
    end
  end

  %% External interactions
  Merchant -.->|Makes API requests<br/>HTTPS/REST| KrakenD
  Admin -.->|Views monitoring dashboards<br/>HTTPS| Grafana
  KrakenD -.->|Validates JWT tokens<br/>HTTP/OAuth2| Keycloak

  %% Gateway routing
  KrakenD --> TxLB
  KrakenD --> CoLB

  %% Load balancing
  TxLB --> TxAPI
  CoLB --> CoAPI

  %% Data access
  TxAPI --> TxPool
  TxPool --> TxDB
  CoAPI --> CoPool
  CoPool --> CoDB

  %% Event-driven communication
  TxAPI --> RabbitMQ
  RabbitMQ --> CoAPI

  %% Monitoring
  Prometheus -.-> TxAPI
  Prometheus -.-> CoAPI
  Prometheus -.-> KrakenD
  Prometheus -.-> RabbitMQ
  Grafana --> Prometheus

  %% Styling
  classDef users fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
  classDef external fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
  classDef gateway fill:#fce4ec,stroke:#c2185b,stroke-width:3px
  classDef api fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px
  classDef database fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
  classDef messaging fill:#fff3e0,stroke:#f57c00,stroke-width:2px
  classDef loadbalancer fill:#e0f2f1,stroke:#00796b,stroke-width:2px
  classDef monitoring fill:#e1f5fe,stroke:#0277bd,stroke-width:2px

  class Merchant,Admin users
  class Keycloak external
  class KrakenD gateway
  class TxAPI,CoAPI api
  class TxDB,CoDB,TxPool,CoPool database
  class RabbitMQ messaging
  class TxLB,CoLB loadbalancer
  class Prometheus,Grafana monitoring