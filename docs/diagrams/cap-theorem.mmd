graph TB
  subgraph CAPTheorem[CAP Theorem - Cash Flow System Analysis]
    subgraph CAPTriangle[CAP Triangle - Choose 2 of 3]
      C[Consistency<br/>All nodes see the same data<br/>at the same time]
      A[Availability<br/>System remains operational<br/>even with node failures]
      P[Partition Tolerance<br/>System continues despite<br/>network partitions]

      C -.->|Cannot guarantee<br/>all three| A
      A -.->|simultaneously| P
      P -.->|Choose 2| C
    end
  end

  subgraph SystemChoice[Cash Flow System Choice: AP - Availability & Partition Tolerance]
    subgraph APChoice[Our Design Decision]
      APReasoning[High Availability + Network Resilience<br/>âœ… Transactions API always available<br/>âœ… Consolidations API independent<br/>âœ… Services survive network issues<br/>âŒ Eventual consistency between services]
    end

    subgraph TradeOffs[Trade-offs Made]
      EventualConsistency[Eventual Consistency<br/>â€¢ Transactions persist immediately<br/>â€¢ Consolidations update asynchronously<br/>â€¢ Brief inconsistency window acceptable<br/>â€¢ Business impact: minimal delay in reports]
    end
  end

  subgraph ImplementationDetails[Implementation Details]
    subgraph ConsistencyLevel[Consistency Levels Applied]
      StrongConsistency[Strong Consistency<br/>WITHIN Each Service<br/>ğŸ“ Transactions DB ACID<br/>ğŸ“ Consolidations DB ACID<br/>ğŸ“ Single service boundaries]

      EventualConsistencyImpl[Eventual Consistency<br/>BETWEEN Services<br/>ğŸ“¡ RabbitMQ async messaging<br/>ğŸ“¡ Event-driven updates<br/>ğŸ“¡ DLQ for failed processing<br/>ğŸ“¡ Measured convergence time]
    end

    subgraph AvailabilityMeasures[Availability Measures]
      ServiceIndependence[Service Independence<br/>ğŸ”„ Transactions work without Consolidations<br/>ğŸ”„ Multiple instances per service<br/>ğŸ”„ HAProxy load balancing<br/>ğŸ”„ Circuit breaker patterns]

      PartitionHandling[Partition Tolerance<br/>ğŸŒ Services in separate networks<br/>ğŸŒ Message queue persistence<br/>ğŸŒ Retry mechanisms<br/>ğŸŒ Graceful degradation]
    end
  end

  subgraph Measurements[Real-World Measurements]
    subgraph ConsistencyMetrics[Consistency Metrics from k6 tests]
      EventualConsistencyRate[Eventual Consistency Rate<br/>âœ… 100% achieved<br/>Target: â‰¥95%]
      ReadConsistencyRate[Read Consistency Rate<br/>âœ… 100% achieved<br/>Target: â‰¥98%]
      CausalConsistencyRate[Causal Consistency Rate<br/>âœ… 100% achieved<br/>Target: â‰¥90%]
      ConvergenceTime[Convergence Time<br/>âœ… p95: 38.08s<br/>Target: <40s]
    end

    subgraph AvailabilityMetrics[Availability Metrics from k6 tests]
      TransactionAvailability[Transaction Service Availability<br/>âœ… 100% during stress<br/>Target: â‰¥95%]
      PeakLoadHandling[Peak Load Handling<br/>âœ… 50+ RPS with 0% errors<br/>Target: â‰¤5% error rate]
      IndependenceValidation[Service Independence<br/>âœ… 0 violations detected<br/>Target: <3 violations]
    end
  end

  subgraph BusinessImpact[Business Impact Analysis]
    subgraph Benefits[Benefits of AP Choice]
      HighAvailability[High Availability<br/>ğŸ’° Revenue protection<br/>ğŸ’° Customer satisfaction<br/>ğŸ’° 24/7 transaction processing<br/>ğŸ’° No single point of failure]

      Scalability[Horizontal Scalability<br/>ğŸ“ˆ Independent service scaling<br/>ğŸ“ˆ Traffic burst handling<br/>ğŸ“ˆ Geographic distribution ready<br/>ğŸ“ˆ Cost-effective growth]
    end

    subgraph AcceptableTradeoffs[Acceptable Trade-offs]
      ReportingDelay[Brief Reporting Delays<br/>â° Max 40s consolidation delay<br/>â° Real-time transactions preserved<br/>â° Business critical path unaffected<br/>â° Monitoring alerts configured]

      EventualConvergence[Guaranteed Convergence<br/>ğŸ¯ All events eventually processed<br/>ğŸ¯ DLQ prevents data loss<br/>ğŸ¯ Manual recovery procedures<br/>ğŸ¯ Audit trail maintained]
    end
  end

  subgraph AlternativeScenarios[Alternative CAP Choices Analysis]
    subgraph CPChoice[CP Choice - Consistency & Partition Tolerance]
      CPTradeoffs[âŒ Would sacrifice Availability<br/>â€¢ Transactions might fail during network issues<br/>â€¢ Strong consistency between services<br/>â€¢ Synchronous processing required<br/>â€¢ Single points of failure]
    end

    subgraph CAChoice[CA Choice - Consistency & Availability]
      CATradeoffs[âŒ Would sacrifice Partition Tolerance<br/>â€¢ System fails during network partitions<br/>â€¢ Tight coupling between services<br/>â€¢ Not suitable for distributed architecture<br/>â€¢ Poor scalability characteristics]
    end
  end

  %% Relationships
  C --> StrongConsistency
  A --> ServiceIndependence
  P --> PartitionHandling

  APChoice --> EventualConsistency
  EventualConsistency --> EventualConsistencyImpl

  EventualConsistencyImpl --> ConsistencyMetrics
  ServiceIndependence --> AvailabilityMetrics

  HighAvailability --> TransactionAvailability
  EventualConvergence --> ConvergenceTime

  %% Styling
  classDef capConcept fill:#fff3e0,stroke:#f57c00,stroke-width:3px
  classDef ourChoice fill:#e8f5e8,stroke:#2e7d32,stroke-width:4px
  classDef implementation fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
  classDef metrics fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
  classDef business fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
  classDef alternative fill:#fce4ec,stroke:#c2185b,stroke-width:2px
  classDef rejected fill:#ffebee,stroke:#d32f2f,stroke-width:2px

  class C,A,P capConcept
  class APChoice,APReasoning ourChoice
  class StrongConsistency,EventualConsistencyImpl,ServiceIndependence,PartitionHandling implementation
  class ConsistencyMetrics,AvailabilityMetrics,EventualConsistencyRate,ReadConsistencyRate,CausalConsistencyRate,ConvergenceTime,TransactionAvailability,PeakLoadHandling,IndependenceValidation metrics
  class Benefits,HighAvailability,Scalability,AcceptableTradeoffs,ReportingDelay,EventualConvergence business
  class AlternativeScenarios alternative
  class CPChoice,CAChoice,CPTradeoffs,CATradeoffs rejected
